const net = require("net");

let clientId = 0;

const bufferList = [
  "232301fe4C46574144524A463031313030323334360100281206050B2C1D00013833363035333337393831363035343930313837020531303030313130303032C2",
  "232302FE4C575843443545343148443630303530380102B012051D090B100101030100570004C56818F326C352010E319400000201010052526C4E206E18F326C30500073BC62801DCE2CB0601250D0C011D0CDA01602B01602B0700000000000000000008010118F326C300C00001C00CF40CED0CF00CF60CEF0CF30CFA0CF40CF60CFA0CF40CF70CFD0CF80CFA0CFD0CF80CFA0CFD0CF80CFA0CFE0CF80CFB0CFF0CF90CFC0CE20CDA0CDE0CED0CE60CE90D0C0D070D090D0C0D070D090D080D030D050D080D030D050D000CFA0CFC0CFD0CF70CFA0CEE0CE70CEA0CEA0CE30CE60CE60CDF0CE20CE60CDF0CE20CE20CDB0CDE0CF60CEF0CF20D060D010D030CFE0CF80CFA0D030CFD0CFF0D030CFD0CFF0CFE0CF80CFB0CFE0CF80CFA0CF50CEF0CF10CF80CF10CF40CF40CED0CF00CF10CF00CEF0CF30CF10CF10CF80CF50CF50CF80CF60CF60CFB0CF90CF90CFC0CF90CFA0CFC0CF90CFA0CFD0CFB0CFB0CFD0CFB0CFB0CDE0CDC0CDC0CEA0CE80CE80D0B0D090D080D0B0D090D090D060D050D050D060D050D050CFE0CFC0CFC0CFB0CF90CF90CEB0CE90CE90CE60CE50CE50CE30CE10CE10CE30CE10CE10CDF0CDD0CDE0CF30CF10CF10D050D020D020CFB0CF90CFA0D000CFE0CFF0D000CFE0CFF0CFC0CFA0CFA0CFB0CF90CF90CF20CF10CF10CF50CF30CF30CF10CF00CEF09010100602B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B2B80001000000000000000000000000000000000810007C2C23430205000820005000000000083001CFA0DAC09C431942EEA18F30000000046F0000040A600001A1F000088840008280028223FF352018500082710271027105100870004000035358C00060000000000008D00060000207E000BF6",
  "232302FE45525230383033303030303030303030300100B71206170C05020101030100320000023D1B583A9832013E121D0065020101013C61A888B83C00783A980500072733A101CF049C060111064001020500010150010540070000000000000000000801011B583A9800110001110640050006400640064006400640064006400640064006400640064006400640064009010100055040404040800030CD0036277E32B038380500000000000000000000001766271A000000000000000000000000121D0000383C000000001674",
  "232303FE4C5758435332303137313130373030303001006B1206150D312F810100020003000004271001000200030000042710010002000300000427100100020003000004271001000200030000042710010002000300000427100100020003000004271001000200030000042710010002000300000427100100020003000004271054",
  "232307FE4838323230363530303030303030303030010000BB",
  "232308FE4552523038303330303030303030303030010000B9",
  "232302FE4C59314341313233354A3030303234333301016B120A1E1021210101030100000002666B106E27145801005208000002010104464E204E203C105E271405010659F7D801C4213806013C0D0B01020D0901013E01023D07000000000000000000080101106E2714007E00017E0D0A0D090D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D090D0A0D090D0A0D0A0D090D0A0D090D0A0D090D0A0D090D090D0A0D090D090D090D090D090D090D0A0D090D0A0D0A0D090D090D0A0D090D090D090D090D090D0A0D0B0D0A0D0A0D090D0A0D090D0A0D0A0D090D0A0D090D0A0D0A0D090D0A0D0A0D090D0A0D090D0A0D090D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0A0D0B0D0A0D0A0D090D0A0D0A0D0A0D0A0D090D0A0D0A0D0A0D0A0D090D0A0D0A0D090D0A0D0A0D0A0D0A0D0A09010100123E3D3D3D3D3D3E3E3E3E3E3E3E3D3E3E3D3E55",
  "232303FE4C464E41344C4441394A4B4C30303038310101B6120A1E0F2B0A010204010000000186A018E6271064010FD6D8000002010104414E204E204518E6271005000714600B01E8042806015C100201130FEC01013A0120390700000000000000000008010118E62710009C00019C0FF50FEF0FF50FF10FF30FF30FFD0FF30FFE0FF70FFA0FEF0FF80FF30FF00FF70FFA0FEF0FEC0FEF0FFD0FF00FF30FF00FF50FEF0FF90FF60FF40FEF0FF70FF50FF70FF00FF50FF50FF30FF30FFA0FF50FF80FF60FF50FEF0FF50FF10FFA0FF10FF80FFC0FF10FF20FF40FF40FFD0FF70FFD0FFB0FF80FF40FFA0FEF0FFD0FEF0FF20FF80FFE10000FFE0FFC0FFA0FFC0FFC0FF50FF910000FF70FF30FF30FFD0FFC0FEE0FF80FF30FEF0FF90FFD0FF50FF70FF40FF610020FF90FF90FFA0FF80FFA0FFA0FF50FFB0FFA0FF40FF00FFB0FFB0FF20FF20FF90FF80FF10FF80FF70FF90FF90FF20FFE0FF90FF90FF40FF90FF50FEF0FF40FF10FF30FF60FF80FF10FEC0FEF0FF40FEF0FF70FF10FF80FEF0FF80FFC10000FF70FF50FF30FF70FF50FFA0FF30FF80FF10FF30FF80FF80FEE0FF60FF10FFC0FF509010100213A3A3A3A3A3A3A3A3A3A3A3A3A3A3A3A3A3A3A3A3A3A3A3A3A3A3A3A3A3A3A3939E9",
  "232301FE4C464E41344C4441394A4B4C303030383101001F120A1E10240000033839383631363136303230303134313030303032010131DF",
];

class FakeClient {
  /**
   * @param {String} mode - fixedLength or onebyone
   * @param {Object} options
   * @param {Number} [options.port = 9527]
   * @param {String} [options.host = 127.0.0.1]
   * @param {Number} [options.interval = 100]
   * @param {Number} [options.length = 1000]
   * @param {Boolean} [options.output = false]
   */
  constructor(mode = "fixedLength", options) {
    this.clientId = clientId;
    clientId += 1;
    this.client = new net.Socket();
    this.options = {
      port: 9527,
      host: "127.0.0.1",
      interval: 1000,
      length: 1000,
      output: false,
      ...options,
    };
    this.client.connect(
      this.options.port,
      this.options.host,
      () => {
        console.log(`#${this.clientId} Connected`);
      }
    );
    this.client.on("data", buf => {
      console.log(
        `#${this.clientId} get data...`,
        this.options.output ? buf.toString("hex") : buf.length
      );
    });
    this.client.on("close", () => {
      console.log(`#${this.clientId} Connection closed`);
    });

    this.timer = this[mode](this.options.interval, this.options.length);
  }

  close() {
    clearInterval(this.timer);
    this.client.end();
  }

  onebyone(interval) {
    let offset = 0;
    return setInterval(() => {
      const bufferString = bufferList[offset % bufferList.length];
      const buf = Buffer.from(bufferString, "hex");
      this.client.write(buf);
      offset += 1;
    }, interval);
  }

  fixedLength(interval, length = 1000) {
    const totalBuffer = Buffer.from(bufferList.join(""), "hex");
    const totalBufferLength = totalBuffer.byteLength;
    console.log("Total buffer length:", totalBufferLength);
    let offset = 0;
    return setInterval(() => {
      console.log("Run...");
      let current = Buffer.alloc(0);
      while (current.length !== length) {
        const rest = length - current.length;
        if (rest > totalBufferLength - offset) {
          current = Buffer.concat([current, totalBuffer.slice(offset, totalBufferLength)]);
          offset = 0;
        } else {
          current = Buffer.concat([current, totalBuffer.slice(offset, offset + rest)]);
          offset += rest;
        }
      }
      this.client.write(current);
    }, interval);
  }
}

const clients = [];

const CLIENT_COUNT = 100;
const INVERVAL = 200;
const MODE = "fixedLength";

for (let i = 0; i < CLIENT_COUNT; i++) {
  const c = new FakeClient(MODE, { interval: INVERVAL });
  clients.push(c);
}
